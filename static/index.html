<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- SEO Primary Meta Tags -->
    <title>Brecha Cambiaria Venezuela - USDT vs D√≥lar BCV en Tiempo Real</title>
    <meta name="title" content="Brecha Cambiaria Venezuela - USDT vs D√≥lar BCV en Tiempo Real" />
    <meta name="description" content="Consulta la brecha cambiaria entre USDT (Binance P2P), D√≥lar BCV y Euro BCV en Venezuela. Tasas actualizadas cada minuto, gr√°ficas hist√≥ricas y calculadora de cambio." />
    <meta name="keywords" content="brecha cambiaria, d√≥lar BCV, USDT Venezuela, tasa de cambio Venezuela, Binance P2P Venezuela, euro BCV, d√≥lar paralelo, calculadora bol√≠vares" />
    <meta name="author" content="Brecha Cambiaria" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="https://brecha-cambiaria.com/" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://brecha-cambiaria.com/" />
    <meta property="og:title" content="Brecha Cambiaria Venezuela - USDT vs D√≥lar BCV" />
    <meta property="og:description" content="Consulta la brecha cambiaria entre USDT, D√≥lar BCV y Euro BCV en Venezuela. Tasas actualizadas cada minuto." />
    <meta property="og:image" content="https://brecha-cambiaria.com/og-image.png" />
    <meta property="og:locale" content="es_VE" />
    <meta property="og:site_name" content="Brecha Cambiaria Venezuela" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://brecha-cambiaria.com/" />
    <meta name="twitter:title" content="Brecha Cambiaria Venezuela - USDT vs D√≥lar BCV" />
    <meta name="twitter:description" content="Consulta la brecha cambiaria entre USDT, D√≥lar BCV y Euro BCV en Venezuela. Tasas actualizadas cada minuto." />
    <meta name="twitter:image" content="https://brecha-cambiaria.com/og-image.png" />

    <!-- PWA / Mobile -->
    <meta name="theme-color" content="#0a0a0a" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Brecha Cambiaria" />

    <!-- Structured Data / JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Brecha Cambiaria Venezuela",
      "url": "https://brecha-cambiaria.com",
      "description": "Aplicaci√≥n para consultar la brecha cambiaria entre USDT, D√≥lar BCV y Euro BCV en Venezuela",
      "applicationCategory": "FinanceApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "author": {
        "@type": "Organization",
        "name": "Brecha Cambiaria"
      }
    }
    </script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-91CBJHBG3D"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-91CBJHBG3D');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap');

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        touch-action: manipulation;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #0a0a0a;
        color: #e0e0e0;
        min-height: 100vh;
        padding: 15px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        text-align: left;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #1a1a1a;
      }

      h1 {
        font-family: 'Inter', sans-serif;
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 5px;
        color: #ffffff;
        letter-spacing: -0.5px;
      }

      .subtitle {
        color: #00ff00;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .subtitle::before {
        content: "";
        width: 8px;
        height: 8px;
        background: #00ff00;
        border-radius: 50%;
        animation: blink 1s infinite;
      }

      @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0.3; }
      }

      .last-update-info {
        text-align: left;
        margin-bottom: 15px;
        padding: 8px 12px;
        background: #0d0d0d;
        border-radius: 4px;
        border-left: 3px solid #00ff00;
      }

      .last-update-info span {
        color: #aaa;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.8rem;
      }

      .cards {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 8px;
        margin-bottom: 20px;
      }

      .card {
        background: #0d0d0d;
        border-radius: 4px;
        padding: 12px;
        text-align: left;
        border: 1px solid #1a1a1a;
        transition: border-color 0.2s;
      }

      .card:hover {
        border-color: #333;
      }

      .card-title {
        font-size: 0.7rem;
        color: #999;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
      }

      .card-value {
        font-family: 'JetBrains Mono', monospace;
        font-size: 1.3rem;
        font-weight: 700;
        letter-spacing: -0.5px;
      }

      .card-value.usdt {
        color: #f0b90b;
      }
      .card-value.bcv {
        color: #00ff00;
      }
      .card-value.eur {
        color: #00d4ff;
      }
      .card-value.brecha {
        color: #ff6b6b;
      }

      .card-change {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.7rem;
        margin-top: 4px;
        color: #777;
      }

      .chart-container {
        background: #0d0d0d;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #1a1a1a;
      }

      .chart-title {
        font-size: 0.9rem;
        margin-bottom: 12px;
        color: #bbb;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .chart-wrapper {
        position: relative;
        height: 280px;
      }

      .status-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 10px 20px;
        min-height: 60px;
        background: #0a0a0a;
        border-top: 1px solid #1a1a1a;
        z-index: 1000;
        gap: 10px;
      }

      .bottom-spacer {
        height: 70px;
      }

      .telegram-btn {
        position: absolute;
        left: 20px;
        width: 40px;
        height: 40px;
        border-radius: 4px;
        background: #1a1a1a;
        border: 1px solid #333;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        text-decoration: none;
      }

      .telegram-btn svg {
        width: 20px;
        height: 20px;
        fill: #aaa;
      }

      .telegram-btn:hover {
        background: #0088cc;
        border-color: #0088cc;
      }

      .telegram-btn:hover svg {
        fill: #fff;
      }

      .share-btn {
        position: absolute;
        right: 20px;
        width: 40px;
        height: 40px;
        border-radius: 4px;
        background: #1a1a1a;
        border: 1px solid #333;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
      }

      .share-btn svg {
        width: 18px;
        height: 18px;
        fill: #aaa;
      }

      .share-btn:hover {
        background: #333;
      }

      .share-btn:hover svg {
        fill: #fff;
      }

      .share-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      #captureArea {
        background: #0a0a0a;
        padding: 15px;
        border-radius: 4px;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      .update-btn-container {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
      }

      .update-btn {
        position: relative;
        width: 44px;
        height: 44px;
        border-radius: 4px;
        background: #1a1a1a;
        border: 1px solid #00ff00;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .update-btn.connected {
        background: rgba(0, 255, 0, 0.1);
        border-color: #00ff00;
        box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
      }

      .update-btn.loading {
        background: rgba(255, 193, 7, 0.1);
        border-color: #ffc107;
        box-shadow: 0 0 20px rgba(255, 193, 7, 0.2);
      }

      .update-btn.error {
        background: rgba(255, 0, 0, 0.1);
        border-color: #ff4444;
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.2);
      }

      .update-btn svg {
        width: 20px;
        height: 20px;
        fill: #00ff00;
        transition: transform 0.3s;
      }

      .update-btn.loading svg {
        fill: #ffc107;
        animation: spin 1s linear infinite;
      }

      .update-btn.error svg {
        fill: #ff4444;
      }

      .update-btn:hover:not(:disabled) {
        background: rgba(0, 255, 0, 0.2);
      }

      .update-btn:hover:not(:disabled) svg {
        transform: rotate(180deg);
      }

      .update-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .update-btn.has-new {
        animation: pulseGreen 1.5s ease-in-out infinite;
      }

      .update-btn.has-new::after {
        content: "";
        position: absolute;
        top: -3px;
        right: -3px;
        width: 10px;
        height: 10px;
        background: #ff4444;
        border-radius: 50%;
        border: 2px solid #0a0a0a;
      }

      @keyframes pulseGreen {
        0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.2); }
        50% { box-shadow: 0 0 30px rgba(0, 255, 0, 0.5); }
      }

      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }

      .legend {
        display: flex;
        justify-content: flex-start;
        gap: 20px;
        margin-top: 12px;
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.75rem;
        color: #999;
        font-family: 'JetBrains Mono', monospace;
      }

      .legend-color {
        width: 16px;
        height: 3px;
        border-radius: 1px;
      }

      /* Calculadora */
      .calculator {
        background: #0d0d0d;
        border-radius: 4px;
        padding: 20px;
        margin-bottom: 15px;
        border: 1px solid #1a1a1a;
      }

      .calc-title {
        font-size: 0.9rem;
        margin-bottom: 15px;
        color: #bbb;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .calc-input-group {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .calc-input-wrapper {
        flex: 1;
        min-width: 180px;
      }

      .calc-label {
        display: block;
        font-size: 0.75rem;
        color: #999;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .calc-input {
        width: 100%;
        padding: 12px;
        border-radius: 4px;
        border: 1px solid #333;
        background: #0a0a0a;
        color: #00ff00;
        font-family: 'JetBrains Mono', monospace;
        font-size: 1.1rem;
        outline: none;
        transition: border-color 0.2s;
      }

      .calc-input:focus {
        border-color: #00ff00;
        box-shadow: 0 0 0 2px rgba(0, 255, 0, 0.1);
      }

      .calc-input-container {
        position: relative;
        width: 100%;
      }

      .calc-input-suffix {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #777;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
        font-weight: 500;
      }

      .calc-input-container .calc-input {
        padding-right: 70px;
      }

      .calc-currency-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .calc-currency-btn {
        flex: 1;
        min-width: 70px;
        padding: 10px 12px;
        border-radius: 4px;
        border: 1px solid #333;
        background: #0a0a0a;
        color: #999;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
      }

      .calc-currency-btn:hover {
        border-color: #555;
        color: #fff;
      }

      .calc-currency-btn.active {
        border-color: #00ff00;
        background: rgba(0, 255, 0, 0.1);
        color: #00ff00;
      }

      .calc-currency-btn.active.ves-btn {
        border-color: #00ff00;
        background: rgba(0, 255, 0, 0.1);
        color: #00ff00;
      }

      .calc-currency-btn.active.eur-btn {
        border-color: #00d4ff;
        background: rgba(0, 212, 255, 0.1);
        color: #00d4ff;
      }

      .calc-currency-btn.active.usdt-btn {
        border-color: #f0b90b;
        background: rgba(240, 185, 11, 0.1);
        color: #f0b90b;
      }

      .calc-currency-btn.active.ref-btn {
        border-color: #ff6b6b;
        background: rgba(255, 107, 107, 0.1);
        color: #ff6b6b;
      }

      .calc-results {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 10px;
      }

      .calc-result-card {
        background: #0a0a0a;
        border-radius: 4px;
        padding: 12px;
        border: 1px solid #1a1a1a;
      }

      .calc-result-label {
        font-size: 0.7rem;
        color: #999;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .calc-result-value {
        font-family: 'JetBrains Mono', monospace;
        font-size: 1.2rem;
        font-weight: 700;
      }

      .calc-result-value.ves {
        color: #00ff00;
      }
      .calc-result-value.bcv {
        color: #00ff00;
      }
      .calc-result-value.eur {
        color: #00d4ff;
      }
      .calc-result-value.usdt {
        color: #f0b90b;
      }
      .calc-result-value.ref {
        color: #ff6b6b;
      }

      .calc-result-rate {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.65rem;
        color: #777;
        margin-top: 4px;
      }

      footer {
        text-align: left;
        padding: 15px 0;
        color: #666;
        font-size: 0.75rem;
        border-top: 1px solid #1a1a1a;
        margin-top: 10px;
      }

      /* Filtro de rango de tiempo */
      .time-filter {
        background: #0d0d0d;
        border-radius: 4px;
        padding: 12px 15px;
        margin-bottom: 12px;
        border: 1px solid #1a1a1a;
      }

      .time-filter-title {
        font-size: 0.75rem;
        color: #999;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .time-filter-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
      }

      .quick-filter-btn {
        padding: 8px 14px;
        min-height: 36px;
        border-radius: 4px;
        border: 1px solid #333;
        background: #0a0a0a;
        color: #999;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
      }

      .quick-filter-btn:hover {
        border-color: #00ff00;
        color: #00ff00;
      }

      .quick-filter-btn.active {
        background: rgba(0, 255, 0, 0.1);
        border-color: #00ff00;
        color: #00ff00;
      }

      .update-btn:focus-visible,
      .calc-currency-btn:focus-visible,
      .quick-filter-btn:focus-visible {
        outline: 2px solid #00ff00;
        outline-offset: 2px;
      }

      @media (max-width: 768px) {
        .cards {
          grid-template-columns: repeat(2, 1fr);
        }
        h1 {
          font-size: 1.2rem;
        }
        .card-value {
          font-size: 1.1rem;
        }
        .chart-wrapper {
          height: 220px;
        }
        .calc-result-value {
          font-size: 1rem;
        }
        .time-filter-controls {
          flex-direction: column;
          align-items: stretch;
        }
      }

      @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      /* Toast notifications */
      .toast-container {
        position: fixed;
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1100;
        display: flex;
        flex-direction: column;
        gap: 8px;
        pointer-events: none;
      }

      .toast {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 15px;
        border-radius: 4px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.8rem;
        font-weight: 500;
        pointer-events: auto;
        animation: toastSlideIn 0.3s ease;
        border: 1px solid;
      }

      .toast.toast-error {
        background: #1a0a0a;
        border-color: #ff4444;
        color: #ff4444;
      }

      .toast.toast-success {
        background: #0a1a0a;
        border-color: #00ff00;
        color: #00ff00;
      }

      .toast.toast-warning {
        background: #1a1a0a;
        border-color: #ffc107;
        color: #ffc107;
      }

      .toast-icon {
        font-size: 1rem;
        flex-shrink: 0;
      }

      .toast-close {
        background: none;
        border: none;
        color: inherit;
        font-size: 1rem;
        cursor: pointer;
        padding: 0;
        margin-left: 8px;
        opacity: 0.7;
        transition: opacity 0.2s;
      }

      .toast-close:hover {
        opacity: 1;
      }

      .toast.toast-hiding {
        animation: toastSlideOut 0.3s ease forwards;
      }

      @keyframes toastSlideIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      @keyframes toastSlideOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-10px); }
      }
    </style>
  </head>
  <body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="container">
      <div id="captureArea">
        <header>
          <h1>Brecha Cambiaria Venezuela</h1>
          <p class="subtitle">Datos actualizados cada minuto</p>
        </header>

        <div class="last-update-info">
          <span id="lastUpdate">Ultima actualizacion: --</span>
        </div>

        <div class="cards">
          <div class="card">
            <div class="card-title">USDT Binance</div>
            <div class="card-value usdt" id="usdtPrice">--</div>
            <div class="card-change">VES/USDT</div>
          </div>
          <div class="card">
            <div class="card-title">Dolar BCV</div>
            <div class="card-value bcv" id="bcvPrice">--</div>
            <div class="card-change">VES/USD</div>
          </div>
          <div class="card">
            <div class="card-title">Euro BCV</div>
            <div class="card-value eur" id="eurPrice">--</div>
            <div class="card-change">VES/EUR</div>
          </div>
          <div class="card">
            <div class="card-title">USDT vs $ BCV</div>
            <div class="card-value brecha" id="brechaUsdtUsd">--</div>
            <div class="card-change">Brecha</div>
          </div>
          <div class="card">
            <div class="card-title">USDT vs ‚Ç¨ BCV</div>
            <div class="card-value brecha" id="brechaUsdtEur">--</div>
            <div class="card-change">Brecha</div>
          </div>
          <div class="card">
            <div class="card-title">‚Ç¨ BCV vs $ BCV</div>
            <div class="card-value brecha" id="brechaEurUsd">--</div>
            <div class="card-change">Brecha</div>
          </div>
        </div>

        <footer>
          <p>Informaci√≥n con fines educativos/informativos</p>
          <p>Datos obtenidos de Binance P2P y Banco Central de Venezuela (BCV)</p>
          <p>Los precios de Binance son promedios ponderados por disponibilidad</p>
        </footer>
      </div>

      <div class="calculator">
        <h3 class="calc-title">üßÆ Calculadora de Cambio</h3>

        <div class="calc-input-group">
          <div class="calc-input-wrapper">
            <label class="calc-label">Moneda de origen</label>
            <div class="calc-currency-buttons">
                <button
                type="button"
                class="calc-currency-btn usdt-btn"
                id="btnUSDT"
                data-currency="USDT"
              >
                USDT
              </button>
              <button
                type="button"
                class="calc-currency-btn active"
                id="btnUSD"
                data-currency="USD"
              >
                $ BCV
              </button>
              <button
                type="button"
                class="calc-currency-btn eur-btn"
                id="btnEUR"
                data-currency="EUR"
              >
                ‚Ç¨ BCV
              </button>
                            <button
                type="button"
                class="calc-currency-btn ref-btn"
                id="btnREF"
                data-currency="REF"
              >
                REF
              </button>
              <button
                type="button"
                class="calc-currency-btn ves-btn"
                id="btnVES"
                data-currency="VES"
              >
                Bs
              </button>
            </div>
          </div>
          <div class="calc-input-wrapper">
            <label class="calc-label" for="calcAmount">Monto</label>
            <div class="calc-input-container">
              <input
                type="number"
                id="calcAmount"
                class="calc-input"
                placeholder="0.00"
                value="100"
                min="0"
                step="0.01"
              />
              <span class="calc-input-suffix" id="calcSuffix">$ BCV</span>
            </div>
          </div>
          <div class="calc-input-wrapper">
            <label class="calc-label" for="calcRefRate">Tasa Referencial (Bs/REF)</label>
            <div class="calc-input-container">
              <input
                type="number"
                id="calcRefRate"
                class="calc-input"
                placeholder="Ej: 500.00"
                min="0"
                step="0.01"
              />
              <span class="calc-input-suffix">Bs/$</span>
            </div>
          </div>
        </div>

        <div class="calc-results">
          <div class="calc-result-card" id="resultVES">
            <div class="calc-result-label">Bolivares (VES)</div>
            <div class="calc-result-value ves" id="calcVES">--</div>
            <div class="calc-result-rate" id="rateVES"></div>
          </div>
          <div class="calc-result-card" id="resultBCV">
            <div class="calc-result-label">Dolar BCV (USD)</div>
            <div class="calc-result-value bcv" id="calcBCV">--</div>
            <div class="calc-result-rate" id="rateBCV"></div>
          </div>
          <div class="calc-result-card" id="resultEUR">
            <div class="calc-result-label">Euro BCV (EUR)</div>
            <div class="calc-result-value eur" id="calcEUR">--</div>
            <div class="calc-result-rate" id="rateEUR"></div>
          </div>
          <div class="calc-result-card" id="resultUSDT">
            <div class="calc-result-label">USDT Binance</div>
            <div class="calc-result-value usdt" id="calcUSDT">--</div>
            <div class="calc-result-rate" id="rateUSDT"></div>
          </div>
          <div class="calc-result-card" id="resultREF">
            <div class="calc-result-label">Tasa Referencial</div>
            <div class="calc-result-value ref" id="calcREF">--</div>
            <div class="calc-result-rate" id="rateREF"></div>
          </div>
        </div>
      </div>

      <div class="time-filter">
        <div class="time-filter-title">Filtrar por rango de tiempo</div>
        <div class="time-filter-controls">
          <button class="quick-filter-btn" data-filter="1h">
            Ultima hora
          </button>
          <button class="quick-filter-btn active" data-filter="24h">
            Ultimas 24h
          </button>
          <button class="quick-filter-btn" data-filter="7d">
            Ultima semana
          </button>
        </div>
      </div>

      <div class="chart-container">
        <h3 class="chart-title">Historico de Precios (VES)</h3>
        <div class="chart-wrapper">
          <canvas id="priceChart"></canvas>
        </div>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-color" style="background: #f0b90b"></div>
            <span>USDT</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #00ff00"></div>
            <span>USD BCV</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #00d4ff"></div>
            <span>EUR BCV</span>
          </div>
        </div>
      </div>

      <div class="chart-container">
        <h3 class="chart-title">Brechas Cambiarias (%)</h3>
        <div class="chart-wrapper">
          <canvas id="brechaChart"></canvas>
        </div>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-color" style="background: #ff4444"></div>
            <span>USDT/USD</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #ff8c00"></div>
            <span>USDT/EUR</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #00d4ff"></div>
            <span>EUR/USD</span>
          </div>
        </div>
      </div>

      <div class="bottom-spacer"></div>
    </div>

    <div class="status-bar">
      <a
        href="https://t.me/brechacambiariabot"
        target="_blank"
        class="telegram-btn"
        title="Abrir Bot de Telegram"
        aria-label="Abrir Bot de Telegram"
      >
        <svg
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
          focusable="false"
        >
          <path
            d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"
          />
        </svg>
      </a>
      <div class="update-btn-container">
        <button
          class="update-btn connected"
          id="updateBtn"
          title="Actualizar precios"
          aria-label="Actualizar precios"
        >
          <svg
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
            aria-hidden="true"
            focusable="false"
          >
            <path
              d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"
            />
          </svg>
        </button>
      </div>
      <button
        class="share-btn"
        id="shareBtn"
        title="Compartir"
        aria-label="Compartir captura"
      >
        <svg
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
          aria-hidden="true"
          focusable="false"
        >
          <path
            d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"
          />
        </svg>
      </button>
    </div>

    <script>
      let currentPrices = {
        bcv_usd: null,
        bcv_eur: null,
        usdt_avg: null,
      };

      let selectedCurrency = "USD";
      let cachedData = null; // Ultimo dato obtenido en background
      let displayedData = null; // Dato actualmente mostrado
      let activeFilter = "24h"; // Filtro activo por defecto

      // Sistema de notificaciones toast
      function showToast(message, type = "error", duration = 5000) {
        const container = document.getElementById("toastContainer");
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;

        const icons = {
          error: "‚ö†Ô∏è",
          success: "‚úì",
          warning: "‚ö°",
        };

        toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.error}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" aria-label="Cerrar notificacion">&times;</button>
            `;

        container.appendChild(toast);

        const closeBtn = toast.querySelector(".toast-close");
        const hideToast = () => {
          toast.classList.add("toast-hiding");
          setTimeout(() => toast.remove(), 300);
        };

        closeBtn.addEventListener("click", hideToast);

        if (duration > 0) {
          setTimeout(hideToast, duration);
        }

        return toast;
      }

      function selectCurrency(currency) {
        selectedCurrency = currency;

        document
          .querySelectorAll(".calc-currency-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document.getElementById("btn" + currency).classList.add("active");

        const suffixes = {
          USD: "$ BCV",
          EUR: "‚Ç¨ BCV",
          VES: "Bs",
          USDT: "USDT",
          REF: "REF",
        };
        document.getElementById("calcSuffix").textContent = suffixes[currency];

        calculateConversion();
      }

      function calculateConversion() {
        const amount =
          parseFloat(document.getElementById("calcAmount").value) || 0;
        const refRate =
          parseFloat(document.getElementById("calcRefRate").value) || null;
        const currency = selectedCurrency;

        if (!currentPrices.bcv_usd || !currentPrices.usdt_avg) return;

        let vesAmount, bcvAmount, eurAmount, usdtAmount, refAmount;

        if (currency === "USD") {
          vesAmount = amount * currentPrices.bcv_usd;
          bcvAmount = amount;
          eurAmount = (amount * currentPrices.bcv_usd) / currentPrices.bcv_eur;
          usdtAmount =
            (amount * currentPrices.bcv_usd) / currentPrices.usdt_avg;
          refAmount = refRate ? (amount * currentPrices.bcv_usd) / refRate : null;
        } else if (currency === "EUR") {
          vesAmount = amount * currentPrices.bcv_eur;
          bcvAmount = (amount * currentPrices.bcv_eur) / currentPrices.bcv_usd;
          eurAmount = amount;
          usdtAmount =
            (amount * currentPrices.bcv_eur) / currentPrices.usdt_avg;
          refAmount = refRate ? (amount * currentPrices.bcv_eur) / refRate : null;
        } else if (currency === "VES") {
          vesAmount = amount;
          bcvAmount = amount / currentPrices.bcv_usd;
          eurAmount = amount / currentPrices.bcv_eur;
          usdtAmount = amount / currentPrices.usdt_avg;
          refAmount = refRate ? amount / refRate : null;
        } else if (currency === "USDT") {
          vesAmount = amount * currentPrices.usdt_avg;
          bcvAmount = (amount * currentPrices.usdt_avg) / currentPrices.bcv_usd;
          eurAmount = (amount * currentPrices.usdt_avg) / currentPrices.bcv_eur;
          usdtAmount = amount;
          refAmount = refRate ? (amount * currentPrices.usdt_avg) / refRate : null;
        } else if (currency === "REF") {
          if (!refRate) {
            document.getElementById("calcVES").textContent = "--";
            document.getElementById("calcBCV").textContent = "--";
            document.getElementById("calcEUR").textContent = "--";
            document.getElementById("calcUSDT").textContent = "--";
            document.getElementById("calcREF").textContent = "--";
            document.getElementById("rateVES").textContent = "Ingrese tasa referencial";
            document.getElementById("rateBCV").textContent = "";
            document.getElementById("rateEUR").textContent = "";
            document.getElementById("rateUSDT").textContent = "";
            document.getElementById("rateREF").textContent = "";
            return;
          }
          vesAmount = amount * refRate;
          bcvAmount = vesAmount / currentPrices.bcv_usd;
          eurAmount = vesAmount / currentPrices.bcv_eur;
          usdtAmount = vesAmount / currentPrices.usdt_avg;
          refAmount = amount;
        }

        document.getElementById("calcVES").textContent =
          vesAmount.toLocaleString("es-VE", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        document.getElementById("calcBCV").textContent =
          bcvAmount.toLocaleString("es-VE", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        document.getElementById("calcEUR").textContent =
          eurAmount.toLocaleString("es-VE", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        document.getElementById("calcUSDT").textContent =
          usdtAmount.toLocaleString("es-VE", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });

        document.getElementById("rateVES").textContent =
          currency === "VES" ? "Monto original" : "";
        document.getElementById("rateBCV").textContent =
          currency === "USD"
            ? "Monto original"
            : `1 USD = ${currentPrices.bcv_usd.toLocaleString("es-VE", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} VES`;
        document.getElementById("rateEUR").textContent =
          currency === "EUR"
            ? "Monto original"
            : `1 EUR = ${currentPrices.bcv_eur.toLocaleString("es-VE", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} VES`;
        document.getElementById("rateUSDT").textContent =
          currency === "USDT"
            ? "Monto original"
            : `1 USDT = ${currentPrices.usdt_avg.toLocaleString("es-VE", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} VES`;

        // Tasa Referencial
        if (currency === "REF") {
          document.getElementById("calcREF").textContent =
            refAmount.toLocaleString("es-VE", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
          document.getElementById("rateREF").textContent = "Monto original";
          document.getElementById("resultREF").style.opacity = "0.6";
        } else if (refAmount !== null) {
          document.getElementById("calcREF").textContent =
            refAmount.toLocaleString("es-VE", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
          document.getElementById("rateREF").textContent =
            `1 $ REF = ${refRate.toLocaleString("es-VE", { minimumFractionDigits: 2, maximumFractionDigits: 2 })} VES`;
          document.getElementById("resultREF").style.opacity = "1";
        } else {
          document.getElementById("calcREF").textContent = "--";
          document.getElementById("rateREF").textContent = "Ingrese tasa";
          document.getElementById("resultREF").style.opacity = "0.6";
        }

        document.getElementById("resultVES").style.opacity =
          currency === "VES" ? "0.6" : "1";
        document.getElementById("resultBCV").style.opacity =
          currency === "USD" ? "0.6" : "1";
        document.getElementById("resultEUR").style.opacity =
          currency === "EUR" ? "0.6" : "1";
        document.getElementById("resultUSDT").style.opacity =
          currency === "USDT" ? "0.6" : "1";
      }

      let priceChart, brechaChart;

      function initCharts() {
        const commonOptions = {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: "index" },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: "#1a1a1a",
              borderColor: "#333",
              borderWidth: 1,
              padding: 10,
              displayColors: true,
              titleFont: { family: "'JetBrains Mono', monospace", size: 11 },
              bodyFont: { family: "'JetBrains Mono', monospace", size: 11 },
              titleColor: "#888",
              bodyColor: "#00ff00",
            },
          },
          scales: {
            x: {
              grid: { color: "#222", lineWidth: 1 },
              ticks: { color: "#aaa", font: { family: "'JetBrains Mono', monospace", size: 11, weight: 500 }, maxTicksLimit: 8 },
            },
            y: {
              grid: { color: "#222", lineWidth: 1 },
              ticks: { color: "#aaa", font: { family: "'JetBrains Mono', monospace", size: 11, weight: 500 } },
            },
          },
        };

        priceChart = new Chart(
          document.getElementById("priceChart").getContext("2d"),
          {
            type: "line",
            data: {
              labels: [],
              datasets: [
                {
                  label: "USDT Binance",
                  data: [],
                  borderColor: "#f0b90b",
                  borderWidth: 2,
                  fill: false,
                  tension: 0.1,
                  pointRadius: 0,
                },
                {
                  label: "Dolar BCV",
                  data: [],
                  borderColor: "#00ff00",
                  borderWidth: 2,
                  fill: false,
                  tension: 0.1,
                  pointRadius: 0,
                },
                {
                  label: "Euro BCV",
                  data: [],
                  borderColor: "#00d4ff",
                  borderWidth: 2,
                  fill: false,
                  tension: 0.1,
                  pointRadius: 0,
                },
              ],
            },
            options: commonOptions,
          },
        );

        brechaChart = new Chart(
          document.getElementById("brechaChart").getContext("2d"),
          {
            type: "line",
            data: {
              labels: [],
              datasets: [
                {
                  label: "USDT vs $ BCV",
                  data: [],
                  borderColor: "#ff4444",
                  borderWidth: 2,
                  fill: true,
                  backgroundColor: "rgba(255, 68, 68, 0.1)",
                  tension: 0.1,
                  pointRadius: 0,
                },
                {
                  label: "USDT vs ‚Ç¨ BCV",
                  data: [],
                  borderColor: "#ff8c00",
                  borderWidth: 2,
                  fill: false,
                  tension: 0.1,
                  pointRadius: 0,
                },
                {
                  label: "‚Ç¨ BCV vs $ BCV",
                  data: [],
                  borderColor: "#00d4ff",
                  borderWidth: 2,
                  fill: false,
                  tension: 0.1,
                  pointRadius: 0,
                },
              ],
            },
            options: {
              ...commonOptions,
              scales: {
                ...commonOptions.scales,
                y: {
                  ...commonOptions.scales.y,
                  ticks: { color: "#888", callback: (v) => v.toFixed(1) + "%" },
                },
              },
            },
          },
        );
      }

      function updateUI(data) {
        currentPrices.bcv_usd = data.bcv_usd;
        currentPrices.bcv_eur = data.bcv_eur;
        currentPrices.usdt_avg = data.usdt_avg;

        calculateConversion();

        document.getElementById("usdtPrice").textContent = data.usdt_avg
          ? data.usdt_avg.toLocaleString("es-VE", { minimumFractionDigits: 2, maximumFractionDigits: 2 })
          : "--";
        document.getElementById("bcvPrice").textContent = data.bcv_usd
          ? data.bcv_usd.toLocaleString("es-VE", { minimumFractionDigits: 2, maximumFractionDigits: 2 })
          : "--";
        document.getElementById("eurPrice").textContent = data.bcv_eur
          ? data.bcv_eur.toLocaleString("es-VE", { minimumFractionDigits: 2, maximumFractionDigits: 2 })
          : "--";
        document.getElementById("brechaUsdtUsd").textContent =
          data.brecha_usdt_usd ? data.brecha_usdt_usd.toFixed(2) + "%" : "--";
        document.getElementById("brechaUsdtEur").textContent =
          data.brecha_usdt_eur ? data.brecha_usdt_eur.toFixed(2) + "%" : "--";
        document.getElementById("brechaEurUsd").textContent =
          data.brecha_eur_usd ? data.brecha_eur_usd.toFixed(2) + "%" : "--";

        const date = new Date(data.timestamp);
        document.getElementById("lastUpdate").textContent =
          "Ultima actualizacion: " + date.toLocaleDateString("es-VE") + " " + date.toLocaleTimeString("es-VE");

        const timeLabel = date.toLocaleTimeString("es-VE", {
          hour: "2-digit",
          minute: "2-digit",
        });

        if (priceChart.data.labels.length > 50) {
          priceChart.data.labels.shift();
          priceChart.data.datasets.forEach((ds) => ds.data.shift());
          brechaChart.data.labels.shift();
          brechaChart.data.datasets.forEach((ds) => ds.data.shift());
        }

        priceChart.data.labels.push(timeLabel);
        priceChart.data.datasets[0].data.push(data.usdt_avg);
        priceChart.data.datasets[1].data.push(data.bcv_usd);
        priceChart.data.datasets[2].data.push(data.bcv_eur);
        priceChart.update("none");

        brechaChart.data.labels.push(timeLabel);
        brechaChart.data.datasets[0].data.push(data.brecha_usdt_usd);
        brechaChart.data.datasets[1].data.push(data.brecha_usdt_eur);
        brechaChart.data.datasets[2].data.push(data.brecha_eur_usd);
        brechaChart.update("none");
      }

      async function loadHistory(start = null, end = null, limit = 100) {
        try {
          let url = "/api/history?limit=" + limit;
          if (start) url += "&start=" + encodeURIComponent(start);
          if (end) url += "&end=" + encodeURIComponent(end);

          const response = await fetch(url);
          const result = await response.json();
          const history = result.data || [];

          priceChart.data.labels = [];
          priceChart.data.datasets.forEach((ds) => (ds.data = []));
          brechaChart.data.labels = [];
          brechaChart.data.datasets.forEach((ds) => (ds.data = []));

          if (history.length > 0) {
            // Mostrar todos los registros del filtro seleccionado
            history.forEach((entry) => {
              const date = new Date(entry.timestamp);
              const timeLabel = date.toLocaleTimeString("es-VE", {
                hour: "2-digit",
                minute: "2-digit",
              });

              priceChart.data.labels.push(timeLabel);
              priceChart.data.datasets[0].data.push(entry.usdt_avg);
              priceChart.data.datasets[1].data.push(entry.bcv_usd);
              priceChart.data.datasets[2].data.push(entry.bcv_eur);

              brechaChart.data.labels.push(timeLabel);
              brechaChart.data.datasets[0].data.push(entry.brecha_usdt_usd);
              brechaChart.data.datasets[1].data.push(entry.brecha_usdt_eur);
              brechaChart.data.datasets[2].data.push(entry.brecha_eur_usd);
            });

            const lastEntry = history[history.length - 1];
            displayedData = lastEntry;

            currentPrices.bcv_usd = lastEntry.bcv_usd;
            currentPrices.bcv_eur = lastEntry.bcv_eur;
            currentPrices.usdt_avg = lastEntry.usdt_avg;

            document.getElementById("usdtPrice").textContent =
              lastEntry.usdt_avg
                ? lastEntry.usdt_avg.toLocaleString("es-VE", {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2,
                  })
                : "--";
            document.getElementById("bcvPrice").textContent = lastEntry.bcv_usd
              ? lastEntry.bcv_usd.toLocaleString("es-VE", {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2,
                })
              : "--";
            document.getElementById("eurPrice").textContent = lastEntry.bcv_eur
              ? lastEntry.bcv_eur.toLocaleString("es-VE", {
                  minimumFractionDigits: 2,
                  maximumFractionDigits: 2,
                })
              : "--";
            document.getElementById("brechaUsdtUsd").textContent =
              lastEntry.brecha_usdt_usd
                ? lastEntry.brecha_usdt_usd.toFixed(2) + "%"
                : "--";
            document.getElementById("brechaUsdtEur").textContent =
              lastEntry.brecha_usdt_eur
                ? lastEntry.brecha_usdt_eur.toFixed(2) + "%"
                : "--";
            document.getElementById("brechaEurUsd").textContent =
              lastEntry.brecha_eur_usd
                ? lastEntry.brecha_eur_usd.toFixed(2) + "%"
                : "--";

            const date = new Date(lastEntry.timestamp);
            document.getElementById("lastUpdate").textContent =
              "Ultima actualizacion: " + date.toLocaleDateString("es-VE") + " " + date.toLocaleTimeString("es-VE");

            calculateConversion();
          }

          priceChart.update("none");
          brechaChart.update("none");
        } catch (error) {
          console.error("Error cargando historial:", error);
          showToast("Error al cargar el historial de precios.", "error");
        }
      }

      function getFilterDates(filter) {
        const now = new Date();
        let start = null;

        switch (filter) {
          case "1h":
            start = new Date(now.getTime() - 60 * 60 * 1000);
            break;
          case "24h":
            start = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            break;
          case "7d":
            start = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            break;
        }

        return { start: start ? start.toISOString() : null, end: null };
      }

      function applyQuickFilter(filter, buttonElement) {
        activeFilter = filter;

        // Actualizar botones activos
        document
          .querySelectorAll(".quick-filter-btn")
          .forEach((btn) => btn.classList.remove("active"));
        if (buttonElement) {
          buttonElement.classList.add("active");
        }

        const dates = getFilterDates(filter);
        // L√≠mites basados en actualizaciones cada 60 segundos
        const limits = { "1h": 100, "24h": 1500, "7d": 11000 };
        loadHistory(dates.start, dates.end, limits[filter] || 1500);
      }


      async function fetchInBackground() {
        try {
          const response = await fetch("/api/latest");
          const data = await response.json();

          if (data.timestamp) {
            cachedData = data;
            checkForNewData();
          }
        } catch (error) {
          console.error("Error en actualizacion background:", error);
        }
      }

      async function refreshOnLoad() {
        const btn = document.getElementById("updateBtn");

        btn.disabled = true;
        btn.classList.remove("connected", "error");
        btn.classList.add("loading");

        try {
          const response = await fetch("/api/refresh", { method: "POST" });
          const result = await response.json();

          if (result.success && result.data) {
            cachedData = result.data;
            displayedData = result.data;
            updateUI(result.data);

            // Recargar historial con el filtro actual
            const dates = getFilterDates(activeFilter);
            const limits = { "1h": 100, "24h": 1500, "7d": 11000 };
            await loadHistory(dates.start, dates.end, limits[activeFilter] || 1500);
          } else if (!result.success) {
            showToast(
              "No se pudieron actualizar los precios. Intenta de nuevo.",
              "error",
            );
          }

          btn.classList.remove("loading", "error");
          btn.classList.add("connected");
        } catch (error) {
          console.error("Error en refresh inicial:", error);
          btn.classList.remove("loading", "connected");
          btn.classList.add("error");
          showToast(
            "Error de conexion. Verifica tu internet e intenta de nuevo.",
            "error",
          );
        } finally {
          btn.disabled = true;
          btn.classList.remove("loading");
        }
      }

      function checkForNewData() {
        const btn = document.getElementById("updateBtn");

        if (cachedData && cachedData.timestamp !== displayedData?.timestamp) {
          btn.classList.add("has-new");
          btn.disabled = false;
        } else {
          btn.classList.remove("has-new");
          btn.disabled = true;
        }
      }

      function showLatestData() {
        const btn = document.getElementById("updateBtn");

        if (cachedData && cachedData.timestamp) {
          updateUI(cachedData);
          displayedData = cachedData;
          btn.classList.remove("has-new", "loading", "error");
          btn.classList.add("connected");
          btn.disabled = true;
        } else {
          // Si no hay datos en cache, cargar del servidor
          btn.disabled = true;
          btn.classList.remove("connected", "error");
          btn.classList.add("loading");

          fetch("/api/latest")
            .then((response) => response.json())
            .then((data) => {
              if (data.timestamp) {
                cachedData = data;
                displayedData = data;
                updateUI(data);
              } else {
                showToast(
                  "No hay datos disponibles aun. Espera la primera actualizacion.",
                  "warning",
                );
              }
              btn.classList.remove("loading", "error");
              btn.classList.add("connected");
            })
            .catch((error) => {
              console.error("Error:", error);
              btn.classList.remove("loading", "connected");
              btn.classList.add("error");
              showToast(
                "Error de conexion. Verifica tu internet e intenta de nuevo.",
                "error",
              );
            })
            .finally(() => {
              btn.disabled = true;
              btn.classList.remove("has-new", "loading");
            });
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        initCharts();

        // Prevenir zoom con doble toque en iOS
        let lastTouchEnd = 0;
        document.addEventListener(
          "touchend",
          (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
              e.preventDefault();
            }
            lastTouchEnd = now;
          },
          { passive: false },
        );

        // Event listeners para botones de moneda
        document.querySelectorAll(".calc-currency-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const currency = btn.dataset.currency;
            selectCurrency(currency);
          });
        });

        // Event listener para input de monto
        document
          .getElementById("calcAmount")
          .addEventListener("input", calculateConversion);

        // Event listener para input de tasa referencial
        document
          .getElementById("calcRefRate")
          .addEventListener("input", calculateConversion);

        // Event listeners para filtros rapidos
        document.querySelectorAll(".quick-filter-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const filter = btn.dataset.filter;
            applyQuickFilter(filter, btn);
          });
        });


        // Event listener para boton de actualizar
        document
          .getElementById("updateBtn")
          .addEventListener("click", showLatestData);

        // Event listener para boton de compartir
        document
          .getElementById("shareBtn")
          .addEventListener("click", shareCapture);

        // Forzar actualizacion de precios al cargar la pagina
        refreshOnLoad();

        // Actualizar en background cada 60 segundos
        setInterval(fetchInBackground, 60000);
      });

      async function shareCapture() {
        const shareBtn = document.getElementById("shareBtn");
        const captureArea = document.getElementById("captureArea");

        shareBtn.disabled = true;

        // Guardar estilos originales
        const originalWidth = captureArea.style.width;
        const originalMaxWidth = captureArea.style.maxWidth;

        // Detectar iOS y Safari
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isIOSSafari = isIOS && isSafari;

        const siteUrl = "https://brecha-cambiaria.com";
        const shareText = "Tasas y Brechas de USDT con BCV actualizadas cada minuto. Informaci√≥n con fines educativos/informativos";

        try {
          // Temporalmente ajustar ancho para captura
          captureArea.style.width = "425px";
          captureArea.style.maxWidth = "425px";

          await new Promise(resolve => setTimeout(resolve, 100));

          const canvas = await html2canvas(captureArea, {
            backgroundColor: "#1a1a2e",
            scale: isIOS ? 1 : 2,
            useCORS: true,
            logging: false,
            allowTaint: true,
            removeContainer: true,
          });

          captureArea.style.width = originalWidth;
          captureArea.style.maxWidth = originalMaxWidth;

          const blob = await new Promise((resolve, reject) => {
            canvas.toBlob(
              (b) => b ? resolve(b) : reject(new Error("No se pudo crear el blob")),
              "image/png",
              1.0
            );
          });

          const file = new File([blob], "brecha-cambiaria.png", { type: "image/png" });

          // iOS Safari: compartir imagen + texto
          if (isIOSSafari && navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
              await navigator.share({
                files: [file],
                text: shareText + "\n" + siteUrl,
              });
              showToast("Compartido exitosamente", "success");
              return;
            } catch (e) {
              if (e.name === "AbortError") return;
            }
          }

          // Otros navegadores con soporte de archivos
          if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
              await navigator.share({
                files: [file],
                title: "Brecha Cambiaria Venezuela",
                text: shareText + "\n" + siteUrl,
              });
              showToast("Compartido exitosamente", "success");
              return;
            } catch (e) {
              if (e.name === "AbortError") return;
            }
          }

          // Compartir solo URL si no soporta archivos
          if (navigator.share) {
            try {
              await navigator.share({
                title: "Brecha Cambiaria Venezuela",
                text: shareText,
                url: siteUrl,
              });
              showToast("Enlace compartido (descarga la imagen por separado)", "success");

              // Descargar imagen despu√©s de compartir URL
              const imgUrl = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = imgUrl;
              a.download = "brecha-cambiaria.png";
              a.click();
              setTimeout(() => URL.revokeObjectURL(imgUrl), 5000);
              return;
            } catch (e) {
              if (e.name === "AbortError") return;
            }
          }

          // Fallback final: guardar imagen en Fotos (iOS) o descargar
          const imgUrl = URL.createObjectURL(blob);

          if (isIOS) {
            // Crear link temporal para guardar en fotos
            const a = document.createElement("a");
            a.href = imgUrl;
            a.download = "brecha-cambiaria.png";
            a.click();

            // Copiar URL
            try {
              await navigator.clipboard.writeText(siteUrl);
              showToast("Imagen guardada. URL copiada al portapapeles.", "success", 4000);
            } catch (e) {
              showToast("Imagen guardada. Comparte: " + siteUrl, "success", 5000);
            }
          } else {
            const a = document.createElement("a");
            a.href = imgUrl;
            a.download = "brecha-cambiaria.png";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            try {
              await navigator.clipboard.writeText(siteUrl);
              showToast("Imagen descargada y URL copiada", "success");
            } catch (e) {
              showToast("Imagen descargada", "success");
            }
          }

          setTimeout(() => URL.revokeObjectURL(imgUrl), 5000);
        } catch (error) {
          console.error("Error al compartir:", error);
          showToast("Error al generar la captura. Intenta de nuevo.", "error");
        } finally {
          // Restaurar estilos originales (por si hubo error antes)
          captureArea.style.width = originalWidth;
          captureArea.style.maxWidth = originalMaxWidth;
          shareBtn.disabled = false;
        }
      }
    </script>
  </body>
</html>
